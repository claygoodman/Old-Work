From:	Donald Goodman (Prithvi Catalytic Inc) <v-dongo@microsoft.com>
Sent:	Sunday, June 24, 2012 7:31 PM
To:	dg@dongoodman.info
Subject:	useful block queries

--gets the basic block
SELECT 
Sp.SPID
,Sp.Status
,sp.hostprocess
,Sp.HostName
,Sp.Loginame
,Sp.CPU
,Sp.Physical_IO
,Sp.Blocked
,DB_NAME(Sp.DBID) as [Database]
,Sp.CMD
,Sp.[Program_Name]
,Sp.UID
,Sp.MemUsage
,Sp.Waitresource
,Sp.WaitType
,Sp.LastWaitType
,Sp.Login_Time
,Sp.Last_Batch
,Sp.Open_tran
,Sp.HostName
,Sp.[sql_handle]
,s2.text 
FROM sys.sysprocesses sp 
CROSS APPLY Sys.Dm_Exec_Sql_Text(Sp.Sql_Handle) As S2 
WHERE SP.spid > 50 and Sp.Blocked > 0 
ORDER BY SP.cpu DESC

--gets the offender
SELECT 
w.session_id AS [Spid]
,DB_NAME(r.database_id) AS [DBName]
,s.[Status]
,w.Blocking_session_id
,w.wait_duration_ms
,s.[Program_name]
,s.Client_interface_name
,s.[Host_name]
,s.cpu_time AS [cpu_time_ms]
,s.Memory_usage* 8/1024 AS [Memory_usage]
,w.wait_type
,r.wait_resource
,s.[deadlock_priority]
,CASE s.transaction_isolation_level
       WHEN 0 THEN 'Unspecified'
       WHEN 1 THEN 'ReadUncomitted'
       WHEN 2 THEN 'Readcomitted'
       WHEN 3 THEN 'Repeatable'
       WHEN 4 THEN 'Serializable'
       WHEN 5 THEN 'Snapshot' 
END AS TRANSACTION_ISOLATION_LEVEL 
,s.Original_login_name
,s.login_time
,s.Last_request_start_time
,s.Last_request_end_time
,r.percent_complete
,s.Row_count
,t.Text
,q.query_plan
,aa.text AS [BlockingText]
FROM sys.dm_os_waiting_tasks AS w 
Inner Join sys.dm_exec_sessions AS s ON w.session_id = s.session_id 
Inner Join sys.dm_exec_requests AS r ON s.session_id = r.session_id 
OUTER APPLY sys.dm_exec_sql_text (r.[sql_handle]) AS t 
Cross Apply Sys.Dm_Exec_Query_Plan(r.Plan_Handle) AS q
outer apply 
(SELECT s2.[text] FROM sys.sysprocesses AS sp 
                CROSS APPLY Sys.Dm_Exec_Sql_Text(Sp.[Sql_Handle]) AS S2 WHERE sp.spid = 
w.Blocking_session_id) AS aa
WHERE s.is_user_process = 1 
AND w.Blocking_session_id > 0
ORDER BY w.wait_duration_ms DESC

--Get the nasty query
--provided by John
SELECT TOP 15 SUBSTRING(qt.TEXT, (qs.statement_start_offset/2)+1, 
((CASE qs.statement_end_offset 
WHEN -1 THEN DATALENGTH(qt.TEXT) 
ELSE qs.statement_end_offset 
END - qs.statement_start_offset)/2)+1), 
qs.execution_count, 
qs.total_logical_reads, qs.last_logical_reads, 
qs.total_logical_writes, qs.last_logical_writes, 
qs.total_worker_time, 
qs.last_worker_time, 
qs.total_elapsed_time/1000000 total_elapsed_time_in_S, 
qs.total_elapsed_time/(qs.execution_count*1000000) average_elapsed_time_in_S, 
qs.last_execution_time, 
qp.query_plan 
FROM sys.dm_exec_query_stats qs 
CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) qt 
CROSS APPLY sys.dm_exec_query_plan(qs.plan_handle) qp 
--ORDER BY qs.total_logical_reads DESC -- logical reads 
--ORDER BY qs.total_logical_writes DESC -- logical writes 
ORDER BY qs.total_worker_time DESC -- CPU time 
-- ORDER BY qs.total_physical_reads DESC -- Physical reads

ALTER AUTHORIZATION ON DATABASE::AdventureWorks TO sa
--replaces sp_changedbowner 'sa'

  SELECT  
BMF.logical_device_name
,BMF.physical_device_name
,BS.backup_finish_date
,DENSE_RANK() OVER (ORDER BY BS.backup_finish_date DESC) AS DR
FROM msdb.dbo.backupmediafamily BMF
INNER JOIN msdb.dbo.backupset BS
ON BMF.media_set_id = BS.media_set_id
WHERE BMF.logical_device_name IS NOT NULL
AND BMF.logical_device_name NOT LIKE '%tran%'
AND BMF.logical_device_name NOT LIKE '%diff%'
GROUP BY BS.backup_finish_date, BMF.logical_device_name, BMF.physical_device_name



SELECT BS.database_name, BMF.physical_device_name, BS.backup_finish_date FROM dbo.backupset BS
INNER JOIN dbo.backupmediafamily BMF 
ON BMF.media_set_id = BS.media_set_id
WHERE BMF.physical_device_name NOT LIKE '%trn%'
ORDER BY BS.backup_finish_date DESC



___________________________
Don Goodman
v-dongo@microsoft.com
Desk +1 (972) 714-6592 x46592
Cell (940) 367-8857
MCTS SQL Server 2008 Admin, Dev

