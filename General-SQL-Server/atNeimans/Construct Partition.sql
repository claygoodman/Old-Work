USE EDDS_PARTWRK
GO
--2010 and before
ALTER DATABASE EDDS_PartWrk ADD FILEGROUP F2010aGrp
ALTER DATABASE EDDS_PartWrk ADD FILEGROUP F2010bGrp

ALTER DATABASE EDDS_PartWrk ADD FILE 
(NAME = F2010a
,FILENAME = 'S:\Data\F2010a_data.NDF'
,SIZE = 1000MB
,FILEGROWTH = 30MB
) TO FILEGROUP F2010aGrp

ALTER DATABASE EDDS_PartWrk ADD FILE 
(NAME = F2010b
,FILENAME = 'S:\Data\F2010b_data.NDF'
,SIZE = 1000MB
,FILEGROWTH = 30MB
) TO FILEGROUP F2010bGrp

--2011
ALTER DATABASE EDDS_PartWrk ADD FILEGROUP F2011aGrp
ALTER DATABASE EDDS_PartWrk ADD FILEGROUP F2011bGrp

ALTER DATABASE EDDS_PartWrk ADD FILE 
(NAME = F2011a
,FILENAME = 'S:\Data\F2011a_data.NDF'
,SIZE = 2000MB
,FILEGROWTH = 30MB
) TO FILEGROUP F2011aGrp

ALTER DATABASE EDDS_PartWrk ADD FILE 
(NAME = F2011b
,FILENAME = 'S:\Data\F2011b_data.NDF'
,SIZE = 2000MB
,FILEGROWTH = 30MB
) TO FILEGROUP F2011bGrp

--2012
ALTER DATABASE EDDS_PartWrk ADD FILEGROUP F2012aGrp
ALTER DATABASE EDDS_PartWrk ADD FILEGROUP F2012bGrp

ALTER DATABASE EDDS_PartWrk ADD FILE 
(NAME = F2012a
,FILENAME = 'S:\Data\F2012a_data.NDF'
,SIZE = 5000MB
,FILEGROWTH = 30MB
) TO FILEGROUP F2012aGrp

ALTER DATABASE EDDS_PartWrk ADD FILE 
(NAME = F2012b
,FILENAME = 'S:\Data\F2012b_data.NDF'
,SIZE = 5000MB
,FILEGROWTH = 30MB
) TO FILEGROUP F2012bGrp

--2013
ALTER DATABASE EDDS_PartWrk ADD FILEGROUP F2013aGrp
ALTER DATABASE EDDS_PartWrk ADD FILEGROUP F2013bGrp

ALTER DATABASE EDDS_PartWrk ADD FILE 
(NAME = F2013a
,FILENAME = 'S:\Data\F2013a_data.NDF'
,SIZE = 10000MB
,FILEGROWTH = 30MB
) TO FILEGROUP F2013aGrp

ALTER DATABASE EDDS_PartWrk ADD FILE 
(NAME = F2013b
,FILENAME = 'S:\Data\F2013b_data.NDF'
,SIZE = 10000MB
,FILEGROWTH = 30MB
) TO FILEGROUP F2013bGrp

--2014
ALTER DATABASE EDDS_PartWrk ADD FILEGROUP F2014aGrp
ALTER DATABASE EDDS_PartWrk ADD FILEGROUP F2014bGrp

ALTER DATABASE EDDS_PartWrk ADD FILE 
(NAME = F2014a
,FILENAME = 'S:\Data\F2014a_data.NDF'
,SIZE = 4000MB
,FILEGROWTH = 30MB
) TO FILEGROUP F2014aGrp

ALTER DATABASE EDDS_PartWrk ADD FILE 
(NAME = F2014b
,FILENAME = 'S:\Data\F2014b_data.NDF'
,SIZE = 4000MB
,FILEGROWTH = 30MB
) TO FILEGROUP F2014bGrp

--2015
ALTER DATABASE EDDS_PartWrk ADD FILEGROUP F2015aGrp
ALTER DATABASE EDDS_PartWrk ADD FILEGROUP F2015bGrp

ALTER DATABASE EDDS_PartWrk ADD FILE 
(NAME = F2015a
,FILENAME = 'S:\Data\F2015a_data.NDF'
,SIZE = 1000MB
,FILEGROWTH = 30MB
) TO FILEGROUP F2015aGrp

ALTER DATABASE EDDS_PartWrk ADD FILE 
(NAME = F2015b
,FILENAME = 'S:\Data\F2015b_data.NDF'
,SIZE = 1000MB
,FILEGROWTH = 30MB
) TO FILEGROUP F2015bGrp

--2016
ALTER DATABASE EDDS_PartWrk ADD FILEGROUP F2016aGrp
ALTER DATABASE EDDS_PartWrk ADD FILEGROUP F2016bGrp

ALTER DATABASE EDDS_PartWrk ADD FILE 
(NAME = F2016a
,FILENAME = 'S:\Data\F2016a_data.NDF'
,SIZE = 1000MB
,FILEGROWTH = 30MB
) TO FILEGROUP F2016aGrp

ALTER DATABASE EDDS_PartWrk ADD FILE 
(NAME = F2016b
,FILENAME = 'S:\Data\F2016b_data.NDF'
,SIZE = 1000MB
,FILEGROWTH = 30MB
) TO FILEGROUP F2016bGrp

--beyond 2016
ALTER DATABASE EDDS_PartWrk ADD FILEGROUP FYOverGrp

ALTER DATABASE EDDS_PartWrk ADD FILE
(NAME = OverFlow
,FILENAME = 'S:\Data\EDDS_OverFlow_Data.NDF'
,SIZE = 1000MB
,FILEGROWTH = 30MB
) TO FILEGROUP FYOverGrp

GO

--Half Year Partitions

CREATE PARTITION FUNCTION fncPartitionAuditRecords(datetime)
AS 
RANGE RIGHT FOR VALUES 
(
N'2010-01-31T00:00:00.000',
N'2010-06-30T00:00:00.000', 
N'2011-01-31T00:00:00.000', 
N'2011-06-30T00:00:00.000',
N'2012-01-31T00:00:00.000', 
N'2012-06-30T00:00:00.000',
N'2013-01-31T00:00:00.000', 
N'2013-06-30T00:00:00.000',
N'2014-01-31T00:00:00.000', 
N'2014-06-30T00:00:00.000',
N'2015-01-31T00:00:00.000', 
N'2015-06-30T00:00:00.000',
N'2016-01-31T00:00:00.000',
N'2016-06-30T00:00:00.000'
)

GO


CREATE PARTITION SCHEME scmPartitionAuditRecords AS PARTITION fncPartitionAuditRecords
TO ([F2010aGrp], [F2010bGrp], [F2011aGrp],[F2011bGrp], [F2012aGrp],[F2012bGrp], [F2013aGrp],[F2013bGrp], 
[F2014aGrp],[F2014bGrp], [F2015aGrp],[F2015bGrp], [F2016aGrp],[F2016bGrp], [FYOverGrp])

GO
--DROP THE INDEXES
IF  EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[eddsdbo].[AuditRecord_PrimaryPartition]') AND name = N'IX_AuditRecord_UserActions')
DROP INDEX [IX_AuditRecord_UserActions] ON [eddsdbo].[AuditRecord_PrimaryPartition] WITH ( ONLINE = OFF )
GO
--Time = 9 minutes
IF  EXISTS (SELECT * FROM sys.indexes WHERE object_id = OBJECT_ID(N'[eddsdbo].[AuditRecord_PrimaryPartition]') AND name = N'PK_AuditRecord')
ALTER TABLE [eddsdbo].[AuditRecord_PrimaryPartition] DROP CONSTRAINT [PK_AuditRecord]
GO
--reclaim space
DBCC SHRINKFILE(EDDS_log)
DBCC SHRINKFILE(EDDS)
DBCC SHRINKDATABASE(EDDS_PARTWRK)
--ADD THE INDEXES
--create the clustered index on the partition scheme
--time = 35 minutes
ALTER TABLE [eddsdbo].[AuditRecord_PrimaryPartition] ADD  CONSTRAINT [PK_AuditRecord] PRIMARY KEY CLUSTERED 
(
	[ID],[TimeStamp] ASC
) ON scmPartitionAuditRecords([Timestamp])
GO

CREATE NONCLUSTERED INDEX [IX_AuditRecord_UserActions] ON [eddsdbo].[AuditRecord_PrimaryPartition] 
(
	[TimeStamp] ASC,
	[Action] ASC,
	[UserID] ASC
)ON scmPartitionAuditRecords([Timestamp])
GO


